/**
 * Created by aesop on 2016/2/1.
 */

'use strict';
const path = require('path');
const symbolLength = 'url('.length;
const urlRegex = /url\(\s*[^(]*\)/g;

const protectBackSlash = x => x.replace(/\\/,'\\\\');

module.exports = function () {
    let dependencies = new Set();

    this.template = this.content.replace(urlRegex, value=> {
        value = value.replace(/['"\s]/g, '');
        let name = value.slice(symbolLength, -1);
        let resolvedPath = path.normalize(this.dir + name);
        dependencies.add(resolvedPath);
        return 'url(<%- data["' + protectBackSlash(resolvedPath) + '"]%>)';
    });
    return dependencies;
};